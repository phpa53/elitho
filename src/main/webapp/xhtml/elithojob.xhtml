<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:component xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="jakarta.tags.core"
	xmlns:cc="jakarta.faces.composite"
	xmlns:f="jakarta.faces.core"
	xmlns:faces="jakarta.faces"
	xmlns:fn="jakarta.tags.functions"
	xmlns:h="jakarta.faces.html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pass="jakarta.faces.passthrough"
	xmlns:ui="jakarta.faces.facelets">
	
	<h:form id="elithojobForm" prependId="false">
		
		<p:growl id="elithojobGrowl" showDetail="true" life="3000"/>
		
		<p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
	        <p:commandButton value="Yes"
				type="button"
				styleClass="ui-confirmdialog-yes ui-button-danger"
				icon="pi pi-check"/>
	        <p:commandButton value="No"
				type="button"
				styleClass="ui-confirmdialog-no ui-button-secondary"
				icon="pi pi-times"/>
		</p:confirmDialog>
		
		<p:dataTable id="elithojobDT"
        	widgetVar="elithojobDTW"
        	var="item"
        	value="#{eLithoJobBean.items}"
        	rowKey="#{item.getKey()}"
			scrollable="true"
			scrollHeight="800"
			lazy="false"
			sortMode="multiple"
			filterMode="advanced"
			virtualScroll="false"
			tableStyle="width:overflow"
			resizableColumns="true"
			resizeMode="expand"
			draggableColumns="true"
			size="small"
			editable="true"
			editInitEvent="click"
			editMode="cell"
            selectionMode="multiple"
            selection="#{eLithoJobBean.selectedItems}"
            selectionPageOnly="false"
            disabledSelection="false"
			stripedRows="true"
			disabledTextSelection="false"
			cache="true"
        	showGridlines="true">
        	
        	<f:facet name="header">
        		<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
		            margin-top:5px;margin-bottom:5px;">
	            	<span style="margin-top:-5px;">
		        		<p:commandButton value="Apply"
			               	actionListener="#{eLithoJobBean.apply}"
			                update="elithojobDT elithoTabView:elithojobGrowl"
							oncomplete="resizeElithoJobTable();"/>
	                    <p:commandButton id="elithojobNewCB"
	                    	title="New"
	                    	icon="pi pi-plus"
		                    styleClass="ml-2 ui-button-success"
		                    rendered="#{facesContext.externalContext.isUserInRole('elitho-write')}"
		                    actionListener="#{eLithoJobBean.add()}"
		                    update="elithojobDT elithoTabView:elithojobGrowl"
		                    oncomplete="resizeElithoJobTable();"/>
	                    <p:commandButton id="elithojobCopyCB"
	                    	title="Copy"
	                    	icon="pi pi-copy"
		                    styleClass="ml-2 ui-button-success"
		                    rendered="#{facesContext.externalContext.isUserInRole('elitho-write')}"
		                    disabled="#{eLithoJobBean.copyDisabled()}"
		                    actionListener="#{eLithoJobBean.copy()}"
		                    update="elithojobDT elithoTabView:elithojobGrowl"
		                    oncomplete="resizeElithoJobTable();"/>
	                    <p:commandButton id="elithojobDeleteCB"
	                    	title="Delete"
	                    	value="#{eLithoJobBean.getDeleteLabel()}"
		                	icon="pi pi-trash"
		                	escape="false"
		                    styleClass="ml-2 ui-button-danger"
		                    rendered="#{facesContext.externalContext.isUserInRole('elitho-write')}"
		                    disabled="#{empty eLithoJobBean.selectedItems}"
		                    actionListener="#{eLithoJobBean.delete()}"
		                    update="@this elithojobDT elithoTabView:elithojobGrowl"
		                    oncomplete="resizeElithoJobTable();">
		                    <p:confirm header="Confirmation"
				            	message="Are you sure you want to delete this item?"
				            	icon="pi pi-exclamation-triangle"/>
		                </p:commandButton>
	                    <p:commandButton id="elithojobSaveCB"
	                    	title="Save"
		                	icon="pi pi-save"
		                    styleClass="ml-2 ui-button-info"
		                    rendered="#{facesContext.externalContext.isUserInRole('elitho-write')}"
		                    disabled="#{eLithoJobBean.saveDisabled()}"
		                    actionListener="#{eLithoJobBean.save()}"
		                    update="elithojobDT elithoTabView:elithojobGrowl"
		                    oncomplete="resizeElithoJobTable();"/>
	                    <p:commandButton id="elithojobDiscardCB"
	                    	title="Discard"
		                	icon="pi pi-undo"
		                    styleClass="ml-2 ui-button-info"
		                    rendered="#{facesContext.externalContext.isUserInRole('elitho-write')}"
		                    disabled="#{not eLithoJobBean.anyItemChanged}"
		                    actionListener="#{eLithoJobBean.discard()}"
		                    update="elithojobDT elithoTabView:elithojobGrowl"
		                    oncomplete="resizeElithoJobTable();"/>
		               	<p:commandButton icon="pi pi-sort-alt-slash"
		               		title="Reset Table"
		               		styleClass="ml-2 ui-button-secondary"
		                    rendered="#{facesContext.externalContext.isUserInRole('elitho-write')}"
		               		action="#{eLithoJobBean.resetTable}"
		               		update="elithojobDT"
		                    oncomplete="resizeElithoJobTable();"/>
		                <p:tooltip for="@next" value="Column to expand"/>
                 		<p:selectOneButton id="jobcolexpandSOB"
		        			value="#{eLithoJobBean.columnToExpand}"
		        			styleClass="ml-2"
		        			unselectable="false"
		        			required="true">
				            <f:selectItem itemLabel="Detection" itemValue="detection"/>
				            <f:selectItem itemLabel="Defect" itemValue="defect"/>
				            <f:selectItem itemLabel="Notif" itemValue="notification"/>
				            <p:ajax event="change"
				            	update="elithojobDT"
				            	oncomplete="updateElithoRows();resizeElithoJobTable();"/>
				        </p:selectOneButton>
		                <p:commandButton icon="pi pi-angle-down"
		                    styleClass="ml-2"
		                    title="Expand All"
		                    type="button"
                 			onclick="expandAllRows('elithojobDTW');elithojobExpanded=true;"/>
		                <p:commandButton icon="pi pi-angle-right"
		                    styleClass="ml-2"
		                    title="Collapse All"
		                	type="button"
                 			onclick="collapseAllRows('elithojobDTW');elithojobExpanded=false;"/>
						<p:outputLabel value="#{eLithoJobBean.numberOfChanges} row(s) changed"
							style="font-weight:bold;color:orange;"
							styleClass="ml-2"
		               		rendered="#{eLithoJobBean.numberOfChanges > 0}"/>
						<p:outputLabel value="#{eLithoJobBean.numberOfDeletes} row(s) deleted"
							style="font-weight:bold;color:orange;"
							styleClass="ml-2"
		               		rendered="#{eLithoJobBean.numberOfDeletes > 0}"/>
					</span>
				</div>
        	</f:facet>
        	
        	<p:ajax event="rowSelect" update="elithojobCopyCB elithojobDeleteCB"/>
            <p:ajax event="rowUnselect" update="elithojobCopyCB elithojobDeleteCB"/>
            <p:ajax event="rowSelectCheckbox" update="elithojobCopyCB elithojobDeleteCB"/>
            <p:ajax event="rowUnselectCheckbox" update="elithojobCopyCB elithojobDeleteCB"/>
            <p:ajax event="toggleSelect" update="elithojobCopyCB elithojobDeleteCB"/>
        	
        	<p:column style="width:10px;" styleClass="#{item.toBeFilled() ? 'cell-to-be-filled' : ''}">
                <p:rowToggler/>
            </p:column>
        	<p:column headerText="M. ID"
        		title="Litho Machine ID"
        		style="width:80px;text-align:center;color:#{item.getAttributeColor()};"
        		styleClass="#{item.hasAttributeChanged('machineId') ? 'cell-changed' : ''}"
				sortBy="#{item.machineId}"
            	filterBy="#{item.machineId}">
            	<p:cellEditor>
                    <f:facet name="output">
                		<h:outputText value="#{item.machineId}"/>
                    </f:facet>
                    <f:facet name="input">
                        <p:inputText value="#{item.machineId}"
                        	style="width:100%"
                        	maxlength="100"
                        	immediate="true"
                        	valueChangeListener="#{eLithoJobBean.valueChanged}"
                        	onkeypress="if (event.keyCode == 13) {e.preventDefault();this.onblur();return false;}">
                        	<f:attribute name="item" value="#{item}"/>
                        	<f:attribute name="attribute" value="machineId"/>
                        	<p:ajax event="blur"
	                       		listener="#{eLithoJobBean.checkKeyUniqueness()}"
                        		process="@this"
		                    	update="elithojobDT elithoTabView:elithojobGrowl"
                        		onstart="saveElithoJobScrollPos();"
		                    	oncomplete="resizeElithoJobTable();setElithoJobScrollPos();"/>
                        </p:inputText>
                    </f:facet>
                </p:cellEditor>
			</p:column>
			<p:column headerText="Detection"
				title="Recipe Detection"
        		style="width:160px;text-align:center;color:#{item.getAttributeColor()};"
        		styleClass="#{item.hasAttributeChanged('recipeDetections') ? 'cell-changed' : ''}"
				sortBy="#{item.recipeDetections}"
            	filterBy="#{item.recipeDetections}">
	            <p:commandLink style="text-decoration:none;"
                    update="elithoTabView:jobDetectionUpdateDialogContent"
                    process="@this"
                    oncomplete="PF('jobDetectionUpdateDialog').show();">
               		<h:outputText id="jobDetectionsOT"
                        value="#{item.getListCompactList(item.recipeDetections, 'detection')}"
                        escape="false"/>
               		<f:setPropertyActionListener target="#{eLithoJobBean.selectedItem}" value="#{item}"/>
           		</p:commandLink>
			</p:column>
			<p:column headerText="Defect"
				title="Recipe Defect"
        		style="width:100px;text-align:center;color:#{item.getAttributeColor()};"
        		styleClass="#{item.hasAttributeChanged('recipeDefects') ? 'cell-changed' : ''}"
				sortBy="#{item.recipeDefects}"
            	filterBy="#{item.recipeDefects}">
	            <p:commandLink style="text-decoration:none;"
                    update="elithoTabView:jobDefectUpdateDialogContent"
                    process="@this"
                    oncomplete="PF('jobDefectUpdateDialog').show();">
               		<h:outputText id="jobDefectsOT"
                        value="#{item.getListCompactList(item.recipeDefects, 'defect')}"
                        escape="false"/>
               		<f:setPropertyActionListener target="#{eLithoJobBean.selectedItem}" value="#{item}"/>
           		</p:commandLink>
			</p:column>
			<p:column headerText="Storage"
				title="Recipe Storage"
        		style="width:100px;text-align:center;color:#{item.getAttributeColor()};"
        		styleClass="#{item.hasAttributeChanged('recipeStorage') ? 'cell-changed' : ''}"
				sortBy="#{item.recipeStorage}"
            	filterBy="#{item.recipeStorage}">
            	<p:cellEditor>
                    <f:facet name="output">
                		<h:outputText value="#{item.recipeStorage}"/>
                    </f:facet>
                    <f:facet name="input">
                    	<p:inputText value="#{item.recipeStorage}"
	                       	style="width:100%"
	                       	maxlength="100"
	                       	immediate="true"
	                       	valueChangeListener="#{eLithoJobBean.valueChanged}"
	                       	onkeypress="if (event.keyCode == 13) {e.preventDefault();this.onblur();return false;}">
	                       	<f:attribute name="item" value="#{item}"/>
	                       	<f:attribute name="attribute" value="recipeStorage"/>
	                       	<p:ajax event="blur"
	                       		listener="#{eLithoJobBean.checkKeyUniqueness()}"
	                       		process="@this"
		                    	update="elithojobDT elithoTabView:elithojobGrowl"
                        		onstart="saveElithoJobScrollPos();"
		                    	oncomplete="resizeElithoJobTable();setElithoJobScrollPos();"/>
                       </p:inputText>
                    </f:facet>
                </p:cellEditor>
			</p:column>
			<p:column headerText="Export"
				title="Recipe Export"
        		style="width:100px;text-align:left;color:#{item.getAttributeColor()};"
        		styleClass="#{item.hasAttributeChanged('recipeExport') ? 'cell-changed' : ''}"
				sortBy="#{item.recipeExport}"
            	filterBy="#{item.recipeExport}">
            	<p:cellEditor>
                    <f:facet name="output">
                		<h:outputText value="#{item.recipeExport}"/>
                    </f:facet>
                    <f:facet name="input">
                    	<p:inputText value="#{item.recipeExport}"
	                       	style="width:100%"
	                       	maxlength="90"
	                       	immediate="true"
	                       	valueChangeListener="#{eLithoJobBean.valueChanged}"
	                       	onkeypress="if (event.keyCode == 13) {e.preventDefault();this.onblur();return false;}">
	                       	<f:attribute name="item" value="#{item}"/>
	                       	<f:attribute name="attribute" value="recipeExport"/>
	                       	<p:ajax event="blur"
	                       		listener="#{eLithoJobBean.checkKeyUniqueness()}"
	                       		process="@this"
		                    	update="elithojobDT elithoTabView:elithojobGrowl"
                        		onstart="saveElithoJobScrollPos();"
		                    	oncomplete="resizeElithoJobTable();setElithoJobScrollPos();"/>
                       </p:inputText>
                    </f:facet>
                </p:cellEditor>
			</p:column>
			<p:column headerText="Notification"
				title="Recipe Notification"
        		style="width:320px;text-align:center;color:#{item.getAttributeColor()};"
        		styleClass="#{item.hasAttributeChanged('recipeNotifications') ? 'cell-changed' : ''}"
				sortBy="#{item.recipeNotifications}"
            	filterBy="#{item.recipeNotifications}">
	            <p:commandLink style="text-decoration:none;"
                    update="elithoTabView:jobNotificationUpdateDialogContent"
                    process="@this"
                    oncomplete="PF('jobNotificationUpdateDialog').show();">
               		<h:outputText id="jobNotificationsOT"
                        value="#{item.getListCompactList(item.recipeNotifications, 'notification')}"
                        escape="false"/>
               		<f:setPropertyActionListener target="#{eLithoJobBean.selectedItem}" value="#{item}"/>
           		</p:commandLink>
			</p:column>
			<ui:remove>
			<p:column headerText="Created"
        		style="width:130px;text-align:center;"
				sortBy="#{item.createdDate}"
            	filterBy="#{item.createdDate}">
                <h:outputText value="#{item.createdDate}" rendered="#{item.isCreatedDateValid()}"/>
            </p:column>
			<p:column headerText="Created By"
        		style="width:130px;text-align:center;"
				sortBy="#{item.createdBy}"
            	filterBy="#{item.createdBy}">
                <h:outputText value="#{item.createdBy}"/>
            </p:column>
			<p:column headerText="Last Modified"
        		style="width:130px;text-align:center;"
				sortBy="#{item.lastModifiedDate}"
            	filterBy="#{item.createdDate}">
                <h:outputText value="#{item.lastModifiedDate}" rendered="#{item.isLastModifiedDateValid()}"/>
            </p:column>
			<p:column headerText="Last Modified By"
        		style="width:130px;text-align:center;"
				sortBy="#{item.lastModifiedBy}"
            	filterBy="#{item.lastModifiedBy}">
                <h:outputText value="#{item.lastModifiedBy}"/>
            </p:column>
            </ui:remove>
			<p:column displayPriority="99"/>
			<p:rowExpansion>
        		<h:outputText value="#{item.getListAsText(item.recipeDetections)}"
        			rendered="#{eLithoJobBean.columnToExpand eq 'detection'}"
        			escape="false"/>
        		<h:outputText value="#{item.getListAsText(item.recipeDefects)}"
        			rendered="#{eLithoJobBean.columnToExpand eq 'defect'}"
        			escape="false"/>
        		<h:outputText value="#{item.getListAsText(item.recipeNotifications)}"
        			rendered="#{eLithoJobBean.columnToExpand eq 'notification'}"
        			escape="false"/>
            </p:rowExpansion>
	        	
		</p:dataTable>
		
	</h:form>
	
	<h:form id="jobDetectionUpdateForm" prependId="false">
		<p:dialog id="jobDetectionUpdateDialog"
	        widgetVar="jobDetectionUpdateDialog"
	        header="Update Job Detection"
	        modal="true"
	        resizable="true"
	        width="520"
	        height="200"
	        closable="true">
		    <h:panelGroup id="jobDetectionUpdateDialogContent" layout="block" style="padding:10px;">
                <p:autoComplete id="jobDetectionAC"
                	style="margin-bottom:20px;"
                	completeMethod="#{eLithoJobBean.completeDetection}"
                	value="#{eLithoJobBean.detectionsToAdd}"
					multiple="true"
					forceSelection="true"
					dropdown="true">
					<p:ajax event="itemSelect"
                        listener="#{eLithoJobBean.addSelectedDetectionToList}"
                        process="@this"
                        update="@this jobDetectionChips jobDetectionsOT"/>
				</p:autoComplete>
	            <p:chips id="jobDetectionChips"
	            	value="#{eLithoJobBean.selectedItem.recipeDetections}"
					styleClass="chips-input-dialog"
					addOnBlur="true">
					<p:ajax event="itemSelect"
		                listener="#{eLithoJobBean.validateLastDetection}"
		                process="@this"
		                update="@this jobDetectionAC jobDetectionsOT"/>
	            </p:chips>
		        <div style="margin-top:15px; text-align:right;">
		        	<p:commandButton styleClass="mr-2"
		        		value="Update"
		        		actionListener="#{eLithoJobBean.checkDetectionChanges()}"
		        		update="elithoTabView:elithojobDT"
		        		oncomplete="PF('jobDetectionUpdateDialog').hide();"/>
		            <p:commandButton value="Close" type="button" onclick="PF('jobDetectionUpdateDialog').hide();"/>
		        </div>
		    </h:panelGroup>
		    <p:ajax event="open" listener="#{eLithoJobBean.resetDetectionChanges()}"/>
		</p:dialog>
	</h:form>
	
	<h:form id="jobDefectUpdateForm" prependId="false">
		<p:dialog id="jobDefectUpdateDialog"
	        widgetVar="jobDefectUpdateDialog"
	        header="Update Job Defect"
	        modal="true"
	        resizable="true"
	        width="800"
	        height="200"
	        closable="true">
		    <h:panelGroup id="jobDefectUpdateDialogContent" layout="block" style="padding:10px;">
                <p:autoComplete id="jobDefectAC"
                	style="margin-bottom:20px;"
                	completeMethod="#{eLithoJobBean.completeDefect}"
                	value="#{eLithoJobBean.defectsToAdd}"
					multiple="true"
					forceSelection="true"
					dropdown="true">
					<p:ajax event="itemSelect"
                        listener="#{eLithoJobBean.addSectedDefectToList}"
                        process="@this"
                        update="@this jobDefectChips jobDefectsOT"/>
				</p:autoComplete>
	            <p:chips id="jobDefectChips"
	            	value="#{eLithoJobBean.selectedItem.recipeDefects}"
					styleClass="chips-input-dialog"
					addOnBlur="true">
					<p:ajax event="itemSelect"
		                listener="#{eLithoJobBean.validateLastDefect}"
		                process="@this"
		                update="@this jobDefectAC jobDefectsOT"/>
	            </p:chips>
		        <div style="margin-top:15px; text-align:right;">
		        	<p:commandButton styleClass="mr-2"
		        		value="Update"
		        		actionListener="#{eLithoJobBean.checkDefectChanges()}"
		        		update="elithoTabView:elithojobDT"
		        		oncomplete="PF('jobDefectUpdateDialog').hide();"/>
		            <p:commandButton value="Close" type="button" onclick="PF('jobDefectUpdateDialog').hide();"/>
		        </div>
		    </h:panelGroup>
		    <p:ajax event="open" listener="#{eLithoJobBean.resetDefectChanges()}"/>
		</p:dialog>
	</h:form>
	
	<h:form id="jobNotificationUpdateForm" prependId="false">
		<p:dialog id="jobNotificationUpdateDialog"
	        widgetVar="jobNotificationUpdateDialog"
	        header="Update Job Notification"
	        modal="true"
	        resizable="true"
	        width="700"
	        height="200"
	        closable="true">
		    <h:panelGroup id="jobNotificationUpdateDialogContent" layout="block" style="padding:10px;">
                <p:autoComplete id="jobNotificationAC"
                	style="margin-bottom:20px;"
                	completeMethod="#{eLithoJobBean.completeNotification}"
                	value="#{eLithoJobBean.notificationsToAdd}"
					multiple="true"
					forceSelection="true"
					dropdown="true">
					<p:ajax event="itemSelect"
                        listener="#{eLithoJobBean.addSectedNotificationToList}"
                        process="@this"
                        update="@this jobNotificationChips jobNotificationsOT"/>
				</p:autoComplete>
	            <p:chips id="jobNotificationChips"
	            	value="#{eLithoJobBean.selectedItem.recipeNotifications}"
					styleClass="chips-input-dialog"
					addOnBlur="true">
					<p:ajax event="itemSelect"
		                listener="#{eLithoJobBean.validateLastNotification}"
		                process="@this"
		                update="@this jobNotificationAC jobNotificationsOT"/>
	            </p:chips>
		        <div style="margin-top:15px; text-align:right;">
		        	<p:commandButton styleClass="mr-2"
		        		value="Update"
		        		actionListener="#{eLithoJobBean.checkNotificationChanges()}"
		        		update="elithoTabView:elithojobDT"
		        		oncomplete="PF('jobNotificationUpdateDialog').hide();"/>
		            <p:commandButton value="Close" type="button" onclick="PF('jobNotificationUpdateDialog').hide();"/>
		        </div>
		    </h:panelGroup>
		    <p:ajax event="open" listener="#{eLithoJobBean.resetNotificationChanges()}"/>
		</p:dialog>
	</h:form>
	
</ui:component>